name: Integration Run (Self-hosted + Proxmox Reset)

on:
  workflow_dispatch:
  push:
    branches: ["**"]
    paths:
      - "install-xfce-xrdp-on-debian.sh"
  pull_request:
    paths:
      - "install-xfce-xrdp-on-debian.sh"

permissions:
  contents: read
  actions: read

jobs:
  reset-vm:
    runs-on: [self-hosted, pve-controller]
    environment: self-hosted-on-tiger
    timeout-minutes: 10

    steps:
      - name: Rollback test VM on Proxmox and wait until runner is online
        env:
          PVE_HOST: ${{ secrets.PVE_HOST }}
          PVE_TOKEN_ID: ${{ secrets.PVE_TOKEN_ID }}
          PVE_TOKEN_SECRET: ${{ secrets.PVE_TOKEN_SECRET }}
          PVE_NODE: ${{ secrets.PVE_NODE }}
          PVE_VMID: ${{ secrets.PVE_VMID }}
          PVE_SNAPSHOT: ${{ secrets.PVE_SNAPSHOT }}
        run: |
          set -euo pipefail
          auth="Authorization: PVEAPIToken=${PVE_TOKEN_ID}=${PVE_TOKEN_SECRET}"

          extract_upid() {
            sed -n 's/.*"data":"\([^"]*\)".*/\1/p'
          }

          wait_upid() {
            local upid="$1"
            local exitstatus=""
            for i in {1..120}; do
              task_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/tasks/${upid}/status")"
              exitstatus="$(echo "$task_json" | sed -n 's/.*"exitstatus":"\([^"]*\)".*/\1/p')"
              status="$(echo "$task_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
              echo "Task $upid check #$i: status=${status:-unknown} exit=${exitstatus:-pending}"
              if [ "$status" = "stopped" ] || [ -n "$exitstatus" ]; then
                break
              fi
              sleep 2
            done
            [ "$exitstatus" = "OK" ]
          }

          echo "Stopping VM ${PVE_VMID}..."
          stop_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/stop" | extract_upid || true)"
          if [ -n "${stop_upid:-}" ]; then
            wait_upid "$stop_upid" || true
          fi

          echo "Rolling back snapshot ${PVE_SNAPSHOT}..."
          rollback_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/snapshot/${PVE_SNAPSHOT}/rollback" | extract_upid)"
          wait_upid "$rollback_upid"

          echo "Starting VM ${PVE_VMID}..."
          start_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/start" | extract_upid)"
          wait_upid "$start_upid"

          echo "Waiting for VM status=running..."
          vm_status=""
          for i in {1..36}; do
            status_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/current")"
            vm_status="$(echo "$status_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
            echo "VM status check #$i: ${vm_status:-unknown}"
            if [ "$vm_status" = "running" ]; then
              break
            fi
            sleep 5
          done

          if [ "${vm_status:-}" != "running" ]; then
            echo "VM did not reach running state in time"
            exit 1
          fi

          echo "VM is running; handoff to run-script job on self-hosted test runner."
  run-script:
    needs: reset-vm
    runs-on: [self-hosted, debian13, minimal]
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run installer script
        run: |
          set -euo pipefail
          chmod +x install-xfce-xrdp-on-debian.sh
          sudo bash ./install-xfce-xrdp-on-debian.sh
