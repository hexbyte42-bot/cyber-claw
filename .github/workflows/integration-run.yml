name: Integration Run (Self-hosted)

on:
  workflow_dispatch:
  push:
    branches: ["**"]
    paths:
      - "install-xfce-xrdp-on-debian.sh"
  pull_request:
    paths:
      - "install-xfce-xrdp-on-debian.sh"

permissions:
  contents: write
  actions: read

concurrency:
  group: selfhosted-pve-vm-global
  cancel-in-progress: false

jobs:
  precheck:
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get -qq update
          sudo apt-get -y -qq install shellcheck

      - name: Bash syntax check
        run: bash -n install-xfce-xrdp-on-debian.sh

      - name: ShellCheck
        run: shellcheck install-xfce-xrdp-on-debian.sh

  reset-vm:
    needs: precheck
    runs-on: [self-hosted, pve-controller]
    environment: self-hosted-on-tiger
    timeout-minutes: 10

    steps:
      - name: Rollback test VM on Proxmox and wait until runner is online
        env:
          PVE_HOST: ${{ secrets.PVE_HOST }}
          PVE_TOKEN_ID: ${{ secrets.PVE_TOKEN_ID }}
          PVE_TOKEN_SECRET: ${{ secrets.PVE_TOKEN_SECRET }}
          PVE_NODE: ${{ secrets.PVE_NODE }}
          PVE_VMID: ${{ secrets.PVE_VMID }}
          PVE_SNAPSHOT: ${{ secrets.PVE_SNAPSHOT }}
        run: |
          set -euo pipefail
          auth="Authorization: PVEAPIToken=${PVE_TOKEN_ID}=${PVE_TOKEN_SECRET}"

          extract_upid() {
            sed -n 's/.*"data":"\([^"]*\)".*/\1/p'
          }

          wait_upid() {
            local upid="$1"
            local exitstatus=""
            for i in {1..120}; do
              task_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/tasks/${upid}/status")"
              exitstatus="$(echo "$task_json" | sed -n 's/.*"exitstatus":"\([^"]*\)".*/\1/p')"
              status="$(echo "$task_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
              echo "Task $upid check #$i: status=${status:-unknown} exit=${exitstatus:-pending}"
              if [ "$status" = "stopped" ] || [ -n "$exitstatus" ]; then
                break
              fi
              sleep 2
            done
            [ "$exitstatus" = "OK" ]
          }

          echo "Shutting down VM ${PVE_VMID} before rollback..."
          shutdown_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/shutdown" | extract_upid || true)"
          if [ -n "${shutdown_upid:-}" ]; then
            wait_upid "$shutdown_upid" || true
          fi

          echo "Rolling back snapshot ${PVE_SNAPSHOT}..."
          rollback_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/snapshot/${PVE_SNAPSHOT}/rollback" | extract_upid)"
          wait_upid "$rollback_upid"

          echo "Starting VM ${PVE_VMID}..."
          start_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/start" | extract_upid)"
          wait_upid "$start_upid"

          echo "Waiting for VM status=running..."
          vm_status=""
          for i in {1..36}; do
            status_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/current")"
            vm_status="$(echo "$status_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
            echo "VM status check #$i: ${vm_status:-unknown}"
            if [ "$vm_status" = "running" ]; then
              break
            fi
            sleep 5
          done

          if [ "${vm_status:-}" != "running" ]; then
            echo "VM did not reach running state in time"
            exit 1
          fi

          echo "VM is running; handoff to run-script job on self-hosted test runner."

  run-script:
    needs: reset-vm
    runs-on: [self-hosted, debian13, minimal]
    timeout-minutes: 60

    steps:
      - name: Ensure git is installed
        run: |
          set -euo pipefail
          if ! command -v git >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y git
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run installer script
        run: |
          set -euo pipefail
          chmod +x install-xfce-xrdp-on-debian.sh
          sudo bash ./install-xfce-xrdp-on-debian.sh --quiet
          sudo sync

      - name: Verify XFCE autostart desktop files
        run: |
          set -euo pipefail
          for f in \
            /home/river/.config/autostart/restart-openclaw-gateway.desktop \
            /home/river/.config/autostart/plank-reloaded.desktop
          do
            echo "==> checking $f"
            sudo ls -l "$f"
            sudo wc -c "$f"
            sudo sed -n '1,30p' "$f"
            sudo test -s "$f"
          done

      - name: Capture XFCE screenshot to assets/screenshot.png
        if: ${{ github.event_name != 'pull_request' }}
        env:
          TARGET_USER: river
        run: |
          set -euo pipefail

          SESSION_DISPLAY=""
          SESSION_DBUS=""

          latest_xrdp_display() {
            xrdp-sesadmin -c=list 2>/dev/null | awk -v u="$TARGET_USER" '
              $1=="Display:" {d=$2}
              $1=="User:" && $2==u {last=d}
              END {print last}
            '
          }

          find_session_context() {
            local uid p env_display env_bus bus_path
            uid="$(id -u "$TARGET_USER")"

            bus_path="/run/user/${uid}/bus"
            if [ -S "$bus_path" ]; then
              SESSION_DBUS="unix:path=$bus_path"
            fi

            SESSION_DISPLAY="$(latest_xrdp_display)"

            if [ -z "${SESSION_DISPLAY:-}" ]; then
              for p in $(pgrep -u "$uid" -f 'dbus-daemon|dbus-broker|xfce4-session|xfconfd|xfce4-panel|Xorg|Xwayland' 2>/dev/null || true); do
                [ -r "/proc/$p/environ" ] || continue
                env_display="$(tr '\0' '\n' < "/proc/$p/environ" | sed -n 's/^DISPLAY=//p' | head -n1)"
                [ -n "${env_display:-}" ] || continue
                SESSION_DISPLAY="$env_display"
                break
              done
            fi

            if [ -z "${SESSION_DBUS:-}" ]; then
              for p in $(pgrep -u "$uid" -f 'dbus-daemon|dbus-broker|xfce4-session|xfconfd|xfce4-panel' 2>/dev/null || true); do
                [ -r "/proc/$p/environ" ] || continue
                env_bus="$(tr '\0' '\n' < "/proc/$p/environ" | sed -n 's/^DBUS_SESSION_BUS_ADDRESS=//p' | head -n1)"
                [ -n "${env_bus:-}" ] || continue
                SESSION_DBUS="$env_bus"
                break
              done
            fi

            [ -n "${SESSION_DISPLAY:-}" ] && [ -n "${SESSION_DBUS:-}" ]
          }

          ensure_session_context() {
            local out disp

            if [ -n "${SESSION_DISPLAY:-}" ] && [ -n "${SESSION_DBUS:-}" ]; then
              return 0
            fi

            echo "Detecting existing graphical session context (DISPLAY + DBUS)..."
            if find_session_context; then
              echo "Found existing session context: DISPLAY=$SESSION_DISPLAY"
              return 0
            fi

            echo "No session context found. Starting XRDP session and re-detecting context..."
            out="$(sudo -u "$TARGET_USER" xrdp-sesrun 2>&1 || true)"
            echo "$out"
            disp="$(echo "$out" | grep -Eo 'display=:[0-9]+' | head -n1 | cut -d= -f2)"
            if [ -n "${disp:-}" ]; then
              SESSION_DISPLAY="$disp"
            fi

            if find_session_context; then
              echo "XRDP session context ready: DISPLAY=$SESSION_DISPLAY"
              return 0
            fi

            echo "Cannot determine graphical session context for $TARGET_USER"
            return 1
          }

          run_in_session_context() {
            ensure_session_context
            echo "XRDP session list:"
            xrdp-sesadmin -c list 2>/dev/null || true
            echo "Using DISPLAY=$SESSION_DISPLAY"
            echo "Using DBUS_SESSION_BUS_ADDRESS=$SESSION_DBUS"
            sudo -u "$TARGET_USER" env DISPLAY="$SESSION_DISPLAY" DBUS_SESSION_BUS_ADDRESS="$SESSION_DBUS" "$@"
          }

          echo "appmenu values before screenshot:"
          run_in_session_context xfconf-query -c xfce4-panel -p /plugins/plugin-2/plugins/plugin-2/bold-application-name || true
          run_in_session_context xfconf-query -c xfce4-panel -p /plugins/plugin-2/plugins/plugin-2/compact-mode || true
          run_in_session_context xfconf-query -c xfce4-panel -p /plugins/plugin-2/plugins/plugin-2/expand || true

          mkdir -p assets
          rm -f assets/screenshot.png

          if command -v xfce4-screenshooter >/dev/null 2>&1; then
            run_in_session_context bash -lc "xfce4-screenshooter -f -s '$PWD/assets/screenshot.png'"
          elif command -v import >/dev/null 2>&1; then
            run_in_session_context bash -lc "import -window root '$PWD/assets/screenshot.png'"
          else
            echo "No screenshot tool available"
            exit 1
          fi

          ls -l assets/screenshot.png
          test -s assets/screenshot.png

      - name: Commit screenshot update
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add assets/screenshot.png
          if git diff --cached --quiet -- assets/screenshot.png; then
            echo "No screenshot change detected"
            exit 0
          fi
          git commit -m "docs: refresh XFCE screenshot"
          git push

  shutdown-vm:
    if: ${{ always() }}
    needs: [reset-vm, run-script]
    runs-on: [self-hosted, pve-controller]
    environment: self-hosted-on-tiger
    timeout-minutes: 10

    steps:
      - name: Shutdown test VM on Proxmox
        env:
          PVE_HOST: ${{ secrets.PVE_HOST }}
          PVE_TOKEN_ID: ${{ secrets.PVE_TOKEN_ID }}
          PVE_TOKEN_SECRET: ${{ secrets.PVE_TOKEN_SECRET }}
          PVE_NODE: ${{ secrets.PVE_NODE }}
          PVE_VMID: ${{ secrets.PVE_VMID }}
        run: |
          set -euo pipefail
          auth="Authorization: PVEAPIToken=${PVE_TOKEN_ID}=${PVE_TOKEN_SECRET}"

          extract_upid() {
            sed -n 's/.*"data":"\([^"]*\)".*/\1/p'
          }

          wait_upid() {
            local upid="$1"
            local exitstatus=""
            for i in {1..120}; do
              task_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/tasks/${upid}/status")"
              exitstatus="$(echo "$task_json" | sed -n 's/.*"exitstatus":"\([^"]*\)".*/\1/p')"
              status="$(echo "$task_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
              echo "Shutdown task $upid check #$i: status=${status:-unknown} exit=${exitstatus:-pending}"
              if [ "$status" = "stopped" ] || [ -n "$exitstatus" ]; then
                break
              fi
              sleep 2
            done
            [ "$exitstatus" = "OK" ]
          }

          echo "Shutting down VM ${PVE_VMID} gracefully after test..."
          shutdown_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/shutdown" | extract_upid || true)"
          if [ -n "${shutdown_upid:-}" ]; then
            wait_upid "$shutdown_upid" || true
          fi

          vm_status=""
          for i in {1..24}; do
            status_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/current")"
            vm_status="$(echo "$status_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
            echo "Post-test shutdown check #$i: ${vm_status:-unknown}"
            if [ "$vm_status" = "stopped" ]; then
              break
            fi
            sleep 5
          done

          if [ "${vm_status:-}" != "stopped" ]; then
            echo "Graceful shutdown did not finish in time, forcing stop..."
            stop_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/stop" | extract_upid || true)"
            if [ -n "${stop_upid:-}" ]; then
              wait_upid "$stop_upid" || true
            fi
          fi

          echo "Shutdown step completed."
