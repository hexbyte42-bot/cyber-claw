name: Integration Run (Self-hosted)

on:
  workflow_dispatch:
  push:
    branches: ["**"]
    paths:
      - "install-xfce-xrdp-on-debian.sh"
      - ".github/workflows/**"
  pull_request:
    paths:
      - "install-xfce-xrdp-on-debian.sh"
      - ".github/workflows/**"

permissions:
  contents: write
  actions: read

concurrency:
  group: selfhosted-pve-vm-global
  cancel-in-progress: false

jobs:
  precheck:
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get -qq update
          sudo apt-get -y -qq install shellcheck

      - name: Bash syntax check
        run: bash -n install-xfce-xrdp-on-debian.sh

      - name: ShellCheck
        run: shellcheck install-xfce-xrdp-on-debian.sh

  reset-vm:
    needs: precheck
    runs-on: [self-hosted, pve-controller]
    environment: self-hosted-on-tiger
    timeout-minutes: 10

    steps:
      - name: Rollback test VM on Proxmox and wait until runner is online
        env:
          PVE_HOST: ${{ secrets.PVE_HOST }}
          PVE_TOKEN_ID: ${{ secrets.PVE_TOKEN_ID }}
          PVE_TOKEN_SECRET: ${{ secrets.PVE_TOKEN_SECRET }}
          PVE_NODE: ${{ secrets.PVE_NODE }}
          PVE_VMID: ${{ secrets.PVE_VMID }}
          PVE_SNAPSHOT: ${{ secrets.PVE_SNAPSHOT }}
        run: |
          set -euo pipefail
          auth="Authorization: PVEAPIToken=${PVE_TOKEN_ID}=${PVE_TOKEN_SECRET}"

          extract_upid() {
            sed -n 's/.*"data":"\([^"]*\)".*/\1/p'
          }

          wait_upid() {
            local upid="$1"
            local exitstatus=""
            for i in {1..120}; do
              task_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/tasks/${upid}/status")"
              exitstatus="$(echo "$task_json" | sed -n 's/.*"exitstatus":"\([^"]*\)".*/\1/p')"
              status="$(echo "$task_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
              echo "Task $upid check #$i: status=${status:-unknown} exit=${exitstatus:-pending}"
              if [ "$status" = "stopped" ] || [ -n "$exitstatus" ]; then
                break
              fi
              sleep 2
            done
            [ "$exitstatus" = "OK" ]
          }

          echo "Shutting down VM ${PVE_VMID} before rollback..."
          shutdown_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/shutdown" | extract_upid || true)"
          if [ -n "${shutdown_upid:-}" ]; then
            wait_upid "$shutdown_upid" || true
          fi

          echo "Rolling back snapshot ${PVE_SNAPSHOT}..."
          rollback_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/snapshot/${PVE_SNAPSHOT}/rollback" | extract_upid)"
          wait_upid "$rollback_upid"

          echo "Starting VM ${PVE_VMID}..."
          start_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/start" | extract_upid)"
          wait_upid "$start_upid"

          echo "Waiting for VM status=running..."
          vm_status=""
          for i in {1..36}; do
            status_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/current")"
            vm_status="$(echo "$status_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
            echo "VM status check #$i: ${vm_status:-unknown}"
            if [ "$vm_status" = "running" ]; then
              break
            fi
            sleep 5
          done

          if [ "${vm_status:-}" != "running" ]; then
            echo "VM did not reach running state in time"
            exit 1
          fi

          echo "VM is running; handoff to run-script job on self-hosted test runner."

  run-script:
    needs: reset-vm
    runs-on: [self-hosted, debian13, minimal]
    timeout-minutes: 60

    steps:
      - name: Ensure git is installed
        run: |
          set -euo pipefail
          if ! command -v git >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y git
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run installer script
        run: |
          set -euo pipefail
          chmod +x install-xfce-xrdp-on-debian.sh
          sudo bash ./install-xfce-xrdp-on-debian.sh --quiet
          sudo sync

      - name: Verify XFCE autostart desktop files
        run: |
          set -euo pipefail
          for f in \
            /home/river/.config/autostart/restart-openclaw-gateway.desktop \
            /home/river/.config/autostart/plank-reloaded.desktop
          do
            echo "==> checking $f"
            sudo ls -l "$f"
            sudo wc -c "$f"
            sudo sed -n '1,30p' "$f"
            sudo test -s "$f"
          done

      - name: Capture XFCE screenshot to assets/screenshot.png
        if: ${{ github.event_name != 'pull_request' }}
        env:
          TARGET_USER: river
        run: |
          set -euo pipefail

          SESSION_DISPLAY="$(xrdp-sesadmin -c=list 2>/dev/null | awk -v u="$TARGET_USER" '
            $1=="Display:" {d=$2}
            $1=="User:" && $2==u {last=d}
            END {print last}
          ')"

          if [ -z "${SESSION_DISPLAY:-}" ]; then
            echo "No XRDP session found. Starting xrdp-sesrun..."
            sudo -u "$TARGET_USER" xrdp-sesrun >/dev/null 2>&1 || true
            SESSION_DISPLAY="$(xrdp-sesadmin -c=list 2>/dev/null | awk -v u="$TARGET_USER" '
              $1=="Display:" {d=$2}
              $1=="User:" && $2==u {last=d}
              END {print last}
            ')"
          fi

          [ -n "${SESSION_DISPLAY:-}" ] || { echo "Cannot determine XRDP DISPLAY"; exit 1; }
          SESSION_DBUS="unix:path=/run/user/$(id -u "$TARGET_USER")/bus"
          [ -S "/run/user/$(id -u "$TARGET_USER")/bus" ] || { echo "DBUS bus socket missing"; exit 1; }

          echo "Using DISPLAY=$SESSION_DISPLAY"
          echo "Using DBUS_SESSION_BUS_ADDRESS=$SESSION_DBUS"

          echo "appmenu values before screenshot:"
          sudo -u "$TARGET_USER" env DISPLAY="$SESSION_DISPLAY" DBUS_SESSION_BUS_ADDRESS="$SESSION_DBUS" xfconf-query -c xfce4-panel -p /plugins/plugin-2/plugins/plugin-2/bold-application-name || true
          sudo -u "$TARGET_USER" env DISPLAY="$SESSION_DISPLAY" DBUS_SESSION_BUS_ADDRESS="$SESSION_DBUS" xfconf-query -c xfce4-panel -p /plugins/plugin-2/plugins/plugin-2/compact-mode || true
          sudo -u "$TARGET_USER" env DISPLAY="$SESSION_DISPLAY" DBUS_SESSION_BUS_ADDRESS="$SESSION_DBUS" xfconf-query -c xfce4-panel -p /plugins/plugin-2/plugins/plugin-2/expand || true

          mkdir -p assets
          rm -f assets/screenshot.png

          echo "Waiting for plank process to appear..."
          for i in {1..30}; do
            if pgrep -u "$(id -u "$TARGET_USER")" -x plank >/dev/null 2>&1; then
              echo "plank is running"
              break
            fi
            sleep 1
          done
          sleep 15

          if command -v xfce4-screenshooter >/dev/null 2>&1; then
            sudo -u "$TARGET_USER" env DISPLAY="$SESSION_DISPLAY" DBUS_SESSION_BUS_ADDRESS="$SESSION_DBUS" xfce4-screenshooter -f -s "$PWD/assets/screenshot.png"
          elif command -v import >/dev/null 2>&1; then
            sudo -u "$TARGET_USER" env DISPLAY="$SESSION_DISPLAY" DBUS_SESSION_BUS_ADDRESS="$SESSION_DBUS" import -window root "$PWD/assets/screenshot.png"
          else
            echo "No screenshot tool available"
            exit 1
          fi

          ls -l assets/screenshot.png
          test -s assets/screenshot.png

      - name: Commit screenshot update
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add assets/screenshot.png
          if git diff --cached --quiet -- assets/screenshot.png; then
            echo "No screenshot change detected"
            exit 0
          fi
          git commit -m "docs: refresh XFCE screenshot"
          git push

  shutdown-vm:
    if: ${{ always() }}
    needs: [reset-vm, run-script]
    runs-on: [self-hosted, pve-controller]
    environment: self-hosted-on-tiger
    timeout-minutes: 10

    steps:
      - name: Shutdown test VM on Proxmox
        env:
          PVE_HOST: ${{ secrets.PVE_HOST }}
          PVE_TOKEN_ID: ${{ secrets.PVE_TOKEN_ID }}
          PVE_TOKEN_SECRET: ${{ secrets.PVE_TOKEN_SECRET }}
          PVE_NODE: ${{ secrets.PVE_NODE }}
          PVE_VMID: ${{ secrets.PVE_VMID }}
        run: |
          set -euo pipefail
          auth="Authorization: PVEAPIToken=${PVE_TOKEN_ID}=${PVE_TOKEN_SECRET}"

          extract_upid() {
            sed -n 's/.*"data":"\([^"]*\)".*/\1/p'
          }

          wait_upid() {
            local upid="$1"
            local exitstatus=""
            for i in {1..120}; do
              task_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/tasks/${upid}/status")"
              exitstatus="$(echo "$task_json" | sed -n 's/.*"exitstatus":"\([^"]*\)".*/\1/p')"
              status="$(echo "$task_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
              echo "Shutdown task $upid check #$i: status=${status:-unknown} exit=${exitstatus:-pending}"
              if [ "$status" = "stopped" ] || [ -n "$exitstatus" ]; then
                break
              fi
              sleep 2
            done
            [ "$exitstatus" = "OK" ]
          }

          echo "Shutting down VM ${PVE_VMID} gracefully after test..."
          shutdown_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/shutdown" | extract_upid || true)"
          if [ -n "${shutdown_upid:-}" ]; then
            wait_upid "$shutdown_upid" || true
          fi

          vm_status=""
          for i in {1..24}; do
            status_json="$(curl -sk -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/current")"
            vm_status="$(echo "$status_json" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')"
            echo "Post-test shutdown check #$i: ${vm_status:-unknown}"
            if [ "$vm_status" = "stopped" ]; then
              break
            fi
            sleep 5
          done

          if [ "${vm_status:-}" != "stopped" ]; then
            echo "Graceful shutdown did not finish in time, forcing stop..."
            stop_upid="$(curl -sk -X POST -H "$auth" "${PVE_HOST}/api2/json/nodes/${PVE_NODE}/qemu/${PVE_VMID}/status/stop" | extract_upid || true)"
            if [ -n "${stop_upid:-}" ]; then
              wait_upid "$stop_upid" || true
            fi
          fi

          echo "Shutdown step completed."
